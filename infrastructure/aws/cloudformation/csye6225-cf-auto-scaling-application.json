{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Application Stack for CSYE 6225 - Spring 2019",
    "Parameters": {
        "NetworkStackNameParameter": {
            "Description": "Network Stack Name",
            "Type": "String"
        },
        "ApplicationStackNameParameter": {
            "Description": "Application Stack Name",
            "Type": "String"
        },
        "KeyName": {
            "Description": "EC2 KeyPair to enable SSH access to the instance",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "ImageID": {
            "Type": "String"
        },
        "PublicSubnetKey3": {
            "Type": "String"
        },
        "PublicSubnetKey2": {
            "Type": "String"
        },
        "PublicSubnetKey1": {
            "Type": "String"
        },
        "VpcID": {
            "Type": "String"
        },
        "S3UploadBucket": {
            "Type": "String"
        },
        "S3CDBucket": {
            "Type": "String"
        },
        "Domain": {
            "Type": "String"
        },
        "certificateARN": {
            "Type": "String"
        }
    },
    "Resources": {
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "csye6225-webapp",
                "GroupDescription": "access for port 80 from load balancer",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "SourceSecurityGroupId": {
                            "Ref": "LBSecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "csye6225-WebAppSecurityGroup"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "388fe87f-7c4e-40d5-8211-0c746147402b"
                }
            }
        },
        "DBServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "csye6225-rds",
                "GroupDescription": "Allowing traffic to port 3306",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "WebServerSecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "csye6225-DBSecurityGroup"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "78901633-db6e-4296-99ee-a276cfc26ee9"
                }
            }
        },
        "RDSSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": "Subnet group for RDS Instances",
                "SubnetIds": [
                    {
                        "Ref": "PublicSubnetKey1"
                    },
                    {
                        "Ref": "PublicSubnetKey2"
                    },
                    {
                        "Ref": "PublicSubnetKey3"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "csye6225-RDSSubnetGroup"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2e03b58e-cff5-4bd4-a32b-b88cc9652b70"
                }
            }
        },
        "RDSInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBName": "csye6225",
                "AllocatedStorage": "100",
                "DBInstanceClass": "db.t2.medium",
                "Engine": "MySQL",
                "MasterUsername": "csye6225master",
                "MasterUserPassword": "csye6225password",
                "MultiAZ": false,
                "DBInstanceIdentifier": "csye6225-spring2019",
                "PubliclyAccessible": true,
                "Port": "3306",
                "DBSubnetGroupName": {
                    "Ref": "RDSSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DBServerSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "csye6225-RDSInstance"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2203852e-140b-4a99-bbef-0f98fd7aaa45"
                }
            }
        },
        "DynamoDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "Id",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "Email",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "Id",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "Email",
                        "KeyType": "RANGE"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": "1",
                    "WriteCapacityUnits": "1"
                },
                "TableName": "csye6225",
                "TimeToLiveSpecification": {
                    "AttributeName": "ExpireTime",
                    "Enabled": "TRUE"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "csye6225-DynamoDBTable"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1438bbb7-29cc-4b09-92f6-b3efd5daeb53"
                }
            }
        },
        "CodeDeployApplication": {
            "Type": "AWS::CodeDeploy::Application",
            "Properties": {
                "ApplicationName": "csye6225-webapp",
                "ComputePlatform": "Server"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "79237857-6d0d-4a94-8ad6-1c08de81445c"
                }
            }
        },
        "CodeDeployDeploymentGroup": {
            "Type": "AWS::CodeDeploy::DeploymentGroup",
            "Properties": {
                "ApplicationName": {
                    "Ref": "CodeDeployApplication"
                },
                "DeploymentGroupName": "csye6225-webapp-deployment",
                "ServiceRoleArn": {
                    "Fn::GetAtt": [
                        "CodeDeployServiceRole",
                        "Arn"
                    ]
                },
                "DeploymentStyle": {
                    "DeploymentOption": "WITHOUT_TRAFFIC_CONTROL",
                    "DeploymentType": "IN_PLACE"
                },
                "DeploymentConfigName": "CodeDeployDefault.AllAtOnce",
                "AutoRollbackConfiguration": {
                    "Enabled": "true",
                    "Events": [
                        "DEPLOYMENT_FAILURE"
                    ]
                },
                "AutoScalingGroups": [
                    {
                        "Ref": "AutoScalingGroup"
                    }
                ],
                "Ec2TagFilters": [
                    {
                        "Key": "CodeDeployTag",
                        "Type": "KEY_AND_VALUE",
                        "Value": "Deploy"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "76379d7c-fab0-4b35-b8f0-4b0f7817c340"
                }
            }
        },
        "CodeDeployServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CodeDeployServiceRole",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "codedeploy.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "370040df-d3f2-419f-9db8-8f9c29efde5a"
                }
            }
        },
        "CodeDeployEC2S3": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "CodeDeploy-EC2-S3",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:ListBucketByTags",
                                "s3:GetLifecycleConfiguration",
                                "s3:GetBucketTagging",
                                "s3:GetInventoryConfiguration",
                                "s3:GetObjectVersionTagging",
                                "s3:ListBucketVersions",
                                "s3:GetBucketLogging",
                                "s3:ListBucket",
                                "s3:GetAccelerateConfiguration",
                                "s3:GetBucketPolicy",
                                "s3:GetObjectVersionTorrent",
                                "s3:GetObjectAcl",
                                "s3:GetEncryptionConfiguration",
                                "s3:GetBucketRequestPayment",
                                "s3:GetObjectVersionAcl",
                                "s3:GetObjectTagging",
                                "s3:GetMetricsConfiguration",
                                "s3:GetBucketPublicAccessBlock",
                                "s3:GetBucketPolicyStatus",
                                "s3:ListBucketMultipartUploads",
                                "s3:GetBucketWebsite",
                                "s3:GetBucketVersioning",
                                "s3:GetBucketAcl",
                                "s3:GetBucketNotification",
                                "s3:GetReplicationConfiguration",
                                "s3:ListMultipartUploadParts",
                                "s3:GetObject",
                                "s3:GetObjectTorrent",
                                "s3:GetBucketCORS",
                                "s3:GetAnalyticsConfiguration",
                                "s3:GetObjectVersionForReplication",
                                "s3:GetBucketLocation",
                                "s3:GetObjectVersion"
                            ],
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Ref": "S3CDBucket"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Ref": "S3CDBucket"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetAccountPublicAccessBlock",
                                "s3:ListAllMyBuckets",
                                "s3:HeadBucket"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "CodeDeployEC2ServiceRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c85674c8-9355-4617-a6f2-76a8f442a8e7"
                }
            }
        },
        "CodeDeployEC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "CodeDeployEC2ServiceRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "aeadf9d5-cb46-49e3-aa43-31b290333bca"
                }
            }
        },
        "CodeDeployEC2ServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CodeDeployEC2ServiceRole",
                "Path": "/",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
                    "arn:aws:iam::aws:policy/AmazonSNSFullAccess"
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "908b31df-07e1-4714-8688-f039a57b3cdc"
                }
            }
        },
        "UploadS3": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "UploadS3",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:PutObject",
                                "s3:DeleteObject",
                                "s3:PutObjectAcl"
                            ],
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Ref": "S3UploadBucket"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "CodeDeployEC2ServiceRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ecfdc397-0cb8-4142-9fea-178c09886c3d"
                }
            }
        },
        "circleciUploadToS3": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:PutObject"
                            ],
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Ref": "S3CDBucket"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Action": "route53:*",
                            "Resource": "*"
                        }
                    ]
                },
                "PolicyName": "circleciUploadToS3",
                "Users": [
                    "circleci"
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e8948f9f-7b61-47f3-8cfa-1baca9ed6f6b"
                }
            }
        },
        "SNSReset": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": "SNSReset"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a28ef1ea-d8f2-4f34-b7eb-d3feffa7d341"
                }
            }
        },
        "LambdaReset": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": "LambdaReset",
                "Handler": "SNSHandler::handleRequest",
                "Code": {
                    "S3Bucket": {
                        "Ref": "S3CDBucket"
                    },
                    "S3Key": "csye6225-spring2019-lambda-1.0-SNAPSHOT.jar"
                },
                "Environment": {
                    "Variables": {
                        "FROM": {
                            "Ref": "Domain"
                        },
                        "timeToLive": "20"
                    }
                },
                "Role": {
                    "Fn::GetAtt": [
                        "IAMLambdaRole",
                        "Arn"
                    ]
                },
                "Runtime": "java8",
                "Timeout": 300,
                "MemorySize": 256
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e88a31bc-47d4-4113-9fdc-9f6fd09f49ab"
                }
            }
        },
        "IAMLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "IAMLambdaRole",
                "Path": "/",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonSESFullAccess",
                    "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccesswithDataPipeline",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1914005c-8151-417b-87da-463322e97555"
                }
            }
        },
        "SNSsub": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "TopicArn": {
                    "Ref": "SNSReset"
                },
                "Endpoint": {
                    "Fn::GetAtt": [
                        "LambdaReset",
                        "Arn"
                    ]
                },
                "Protocol": "lambda"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8a887d1e-39f4-42f3-ba33-49b6277b84f9"
                }
            },
            "DependsOn": [
                "SNSReset",
                "LambdaReset"
            ]
        },
        "LambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "Principal": "sns.amazonaws.com",
                "SourceArn": {
                    "Ref": "SNSReset"
                },
                "FunctionName": {
                    "Fn::GetAtt": [
                        "LambdaReset",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a5078c7c-6043-480b-b03a-228dd1009bcd"
                }
            },
            "DependsOn": [
                "LambdaReset",
                "SNSReset"
            ]
        },
        "LaunchConfiguration": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": {
                    "Ref": "ImageID"
                },
                "InstanceType": "t2.micro",
                "KeyName": {
                    "Ref": "KeyName"
                },
                "AssociatePublicIpAddress": true,
                "IamInstanceProfile": {
                    "Ref": "CodeDeployEC2InstanceProfile"
                },
                "LaunchConfigurationName": "asg_launch_config",
                "SecurityGroups": [
                    {
                        "Ref": "WebServerSecurityGroup"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash -xe ",
                                "sudo service codedeploy-agent start",
                                "sudo -s",
                                "echo '#!/bin/bash' >> /home/centos/vars.sh",
                                "cd /home/centos/",
                                "chmod +x ./vars.sh",
                                "echo -n 'java -jar springbootdemo-0.0.1-SNAPSHOT.jar --spring.datasource.username=csye6225master --spring.datasourse.password=csye6225password --spring.profiles.active=dev' >> /home/centos/vars.sh",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "echo -n ' --spring.datasource.url=jdbc:mysql://",
                                            {
                                                "Fn::GetAtt": [
                                                    "RDSInstance",
                                                    "Endpoint.Address"
                                                ]
                                            },
                                            ":3306/csye6225' >> /home/centos/vars.sh"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "echo -n ' --aws.sns.topic.ARN=arn:aws:sns:",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ":",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":SNSReset' >> /home/centos/vars.sh"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "echo ' --aws.s3.audio.bucket=",
                                            {
                                                "Ref": "S3UploadBucket"
                                            },
                                            "' >> /home/centos/vars.sh"
                                        ]
                                    ]
                                }
                            ]
                        ]
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "3ea01e2e-8324-4129-aa8d-40d93e9e48ff"
                }
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "Cooldown": "60",
                "LaunchConfigurationName": {
                    "Ref": "LaunchConfiguration"
                },
                "MinSize": "3",
                "MaxSize": "10",
                "DesiredCapacity": "3",
                "VPCZoneIdentifier": [
                    {
                        "Ref": "PublicSubnetKey1"
                    },
                    {
                        "Ref": "PublicSubnetKey2"
                    },
                    {
                        "Ref": "PublicSubnetKey3"
                    }
                ],
                "TargetGroupARNs": [
                    {
                        "Ref": "ALBTargetGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "CodeDeployTag",
                        "Value": "Deploy",
                        "PropagateAtLaunch": true
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1b6331de-f8d1-4e22-a15d-049b15a9f5da"
                }
            }
        },
        "WebServerScaleUpPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AdjustmentType": "ChangeInCapacity",
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "Cooldown": "60",
                "ScalingAdjustment": "1"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9512e36a-aa62-442f-a462-d4ac83fa7d29"
                }
            }
        },
        "WebServerScaleDownPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AdjustmentType": "ChangeInCapacity",
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "Cooldown": "60",
                "ScalingAdjustment": "-1"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "cf9224ff-334c-47d2-89b3-a7e46c6cd15c"
                }
            }
        },
        "CPUAlarmHigh": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Scale-up if CPU > 10% for 10 minutes",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": "300",
                "EvaluationPeriods": "2",
                "Threshold": "10",
                "AlarmActions": [
                    {
                        "Ref": "WebServerScaleUpPolicy"
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "ComparisonOperator": "GreaterThanThreshold"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "213e74d5-ccf6-4193-8dbf-c9bf2ae5c2b4"
                }
            }
        },
        "CPUAlarmLow": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Scale-down if CPU < 5% for 10 minutes",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": "300",
                "EvaluationPeriods": "2",
                "Threshold": "5",
                "AlarmActions": [
                    {
                        "Ref": "WebServerScaleDownPolicy"
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "ComparisonOperator": "LessThanThreshold"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "3e6cf6c6-3696-4f3e-8131-3597a0e65770"
                }
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Subnets": [
                    {
                        "Ref": "PublicSubnetKey1"
                    },
                    {
                        "Ref": "PublicSubnetKey2"
                    },
                    {
                        "Ref": "PublicSubnetKey3"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "LBSecurityGroup"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9a0aa546-a93f-4752-8b3a-63e758bffcca"
                }
            }
        },
        "ALBTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VpcID"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "861f4e2b-0bfb-483e-909b-a16e0306106a"
                }
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": "443",
                "Protocol": "HTTPS",
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Ref": "certificateARN"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "6cba43d7-5748-491b-9787-9a63680e040d"
                }
            }
        },
        "LBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "csye6225-LB",
                "GroupDescription": "access for port 443 (https default) from anywhere",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0059fe1c-d7d3-4150-a336-c47cf692d360"
                }
            }
        },
        "AliasRecordSetGroup": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Domain"
                            },
                            "."
                        ]
                    ]
                },
                "Comment": "alias record for ELB",
                "RecordSets": [
                    {
                        "Name": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Domain"
                                    },
                                    "."
                                ]
                            ]
                        },
                        "Type": "A",
                        "AliasTarget": {
                            "HostedZoneId": {
                                "Fn::GetAtt": [
                                    "ApplicationLoadBalancer",
                                    "CanonicalHostedZoneID"
                                ]
                            },
                            "DNSName": {
                                "Fn::GetAtt": [
                                    "ApplicationLoadBalancer",
                                    "DNSName"
                                ]
                            }
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1cce205c-1ee0-45bf-b227-4c67765fd7ff"
                }
            }
        }
    },
    "Outputs": {
        "WebServerSecurityGroup": {
            "Description": "The security group id for the Web Server",
            "Value": {
                "Ref": "WebServerSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "WebServerSecurityGroupID"
                }
            }
        },
        "DBServerSecurityGroup": {
            "Description": "The security group id for the RDS Server",
            "Value": {
                "Ref": "DBServerSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "DBServerSecurityGroupID"
                }
            }
        },
        "RDSInstance": {
            "Description": "The RDS Instance for Backend Database",
            "Value": {
                "Ref": "RDSInstance"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "RDSInstanceID"
                }
            }
        },
        "DynamoDBTable": {
            "Description": "The DynamoDBTableId",
            "Value": {
                "Ref": "DynamoDBTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "DynamoDBTableID"
                }
            }
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "0059fe1c-d7d3-4150-a336-c47cf692d360": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -140,
                    "y": 690
                },
                "z": 1,
                "embeds": []
            },
            "861f4e2b-0bfb-483e-909b-a16e0306106a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -320,
                    "y": 520
                },
                "z": 1,
                "embeds": []
            },
            "9a0aa546-a93f-4752-8b3a-63e758bffcca": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -320,
                    "y": 670
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "0059fe1c-d7d3-4150-a336-c47cf692d360"
                ]
            },
            "1cce205c-1ee0-45bf-b227-4c67765fd7ff": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -320,
                    "y": 790
                },
                "z": 1,
                "embeds": []
            },
            "6cba43d7-5748-491b-9787-9a63680e040d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -430,
                    "y": 580
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "9a0aa546-a93f-4752-8b3a-63e758bffcca"
                ]
            },
            "1914005c-8151-417b-87da-463322e97555": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1050,
                    "y": 100
                },
                "z": 1,
                "embeds": []
            },
            "e88a31bc-47d4-4113-9fdc-9f6fd09f49ab": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1040,
                    "y": 230
                },
                "z": 1,
                "embeds": []
            },
            "a28ef1ea-d8f2-4f34-b7eb-d3feffa7d341": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1060,
                    "y": 530
                },
                "z": 1,
                "embeds": []
            },
            "a5078c7c-6043-480b-b03a-228dd1009bcd": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 930,
                    "y": 440
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "e88a31bc-47d4-4113-9fdc-9f6fd09f49ab"
                ]
            },
            "8a887d1e-39f4-42f3-ba33-49b6277b84f9": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1150,
                    "y": 380
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "a28ef1ea-d8f2-4f34-b7eb-d3feffa7d341"
                ]
            },
            "e8948f9f-7b61-47f3-8cfa-1baca9ed6f6b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 540,
                    "y": 450
                },
                "z": 1,
                "embeds": []
            },
            "908b31df-07e1-4714-8688-f039a57b3cdc": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 60,
                    "y": 510
                },
                "z": 1,
                "embeds": []
            },
            "ecfdc397-0cb8-4142-9fea-178c09886c3d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 180,
                    "y": 510
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "908b31df-07e1-4714-8688-f039a57b3cdc"
                ]
            },
            "aeadf9d5-cb46-49e3-aa43-31b290333bca": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 300,
                    "y": 570
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "908b31df-07e1-4714-8688-f039a57b3cdc"
                ]
            },
            "c85674c8-9355-4617-a6f2-76a8f442a8e7": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 420,
                    "y": 570
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "908b31df-07e1-4714-8688-f039a57b3cdc"
                ]
            },
            "370040df-d3f2-419f-9db8-8f9c29efde5a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 540,
                    "y": 570
                },
                "z": 1,
                "embeds": []
            },
            "79237857-6d0d-4a94-8ad6-1c08de81445c": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 600,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            },
            "1438bbb7-29cc-4b09-92f6-b3efd5daeb53": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 600,
                    "y": 210
                },
                "z": 1,
                "embeds": []
            },
            "2e03b58e-cff5-4bd4-a32b-b88cc9652b70": {
                "size": {
                    "width": 240,
                    "height": 240
                },
                "position": {
                    "x": -370,
                    "y": 170
                },
                "z": 1,
                "embeds": [
                    "2203852e-140b-4a99-bbef-0f98fd7aaa45"
                ]
            },
            "388fe87f-7c4e-40d5-8211-0c746147402b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 600,
                    "y": 330
                },
                "z": 1,
                "embeds": []
            },
            "78901633-db6e-4296-99ee-a276cfc26ee9": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 660,
                    "y": 450
                },
                "z": 1,
                "embeds": []
            },
            "2203852e-140b-4a99-bbef-0f98fd7aaa45": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -340,
                    "y": 230
                },
                "z": 2,
                "parent": "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                "embeds": [],
                "isassociatedwith": [
                    "78901633-db6e-4296-99ee-a276cfc26ee9"
                ],
                "iscontainedinside": [
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70",
                    "2e03b58e-cff5-4bd4-a32b-b88cc9652b70"
                ]
            },
            "3ea01e2e-8324-4129-aa8d-40d93e9e48ff": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 660,
                    "y": 570
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "388fe87f-7c4e-40d5-8211-0c746147402b"
                ]
            },
            "1b6331de-f8d1-4e22-a15d-049b15a9f5da": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -100,
                    "y": 610
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "3ea01e2e-8324-4129-aa8d-40d93e9e48ff",
                    "861f4e2b-0bfb-483e-909b-a16e0306106a"
                ]
            },
            "cf9224ff-334c-47d2-89b3-a7e46c6cd15c": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 180,
                    "y": 630
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "1b6331de-f8d1-4e22-a15d-049b15a9f5da"
                ]
            },
            "3e6cf6c6-3696-4f3e-8131-3597a0e65770": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 720,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            },
            "9512e36a-aa62-442f-a462-d4ac83fa7d29": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 720,
                    "y": 210
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "1b6331de-f8d1-4e22-a15d-049b15a9f5da"
                ]
            },
            "213e74d5-ccf6-4193-8dbf-c9bf2ae5c2b4": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 720,
                    "y": 330
                },
                "z": 1,
                "embeds": []
            },
            "76379d7c-fab0-4b35-b8f0-4b0f7817c340": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 300,
                    "y": 690
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "1b6331de-f8d1-4e22-a15d-049b15a9f5da",
                    "79237857-6d0d-4a94-8ad6-1c08de81445c"
                ]
            }
        }
    }
}